<div id="categories_viewer_modal" class="modal fade"  role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <a class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></a>
        <%= render partial: 'help/help_categorize' %>
        <h4 class="modal-title"><%= t("category.modalLabel")%></h4>
      </div>

      <div class="modal-body">
        
    <% generic_categories = Category.authored_by(current_subject).sort_by!{|e| e.title.downcase} %>
    <p class= "information"><%= t("category.cat_add_title")%></p> 
    
   <div class="dropdown">
      <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown">
        <b><%= t("category.cat_add_select")%></b>
        <span class="caret"></span>
      </button>
        <ul id="catDropdownSel" class="dropdown-menu scroll-menu" role="menu" aria-labelledby="dropdownMenu1">
        <% generic_categories.each do |init| %> 

        <li role="presentation" value="<%=init.id%>"><a role="menuitem" tabindex="-1" ><%=init.title%></a></li>

        
        <!-- Juancar echalé un ojo-->
       <div class="dropdown">
          <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown">
            <b><%= t("category.cat_add_select")%></b>
            <span class="caret"></span>
          </button>
            <ul id="catDropdownSel" class="dropdown-menu scroll-menu" role="menu" aria-labelledby="dropdownMenu1">
            <% generic_categories.each do |init| %> 

            <li role="presentation" value="<%=init.id%>"><a role="menuitem" tabindex="-1" ><%=init.title%></a></li>
            
            <% end %>
          </ul>
        </div>

         <!--<p class= "information"><%= t("category.cat_popular")%></p>-->
         <br>
         <div id="suggested_categories" class="tagBoxNew">
            <% rcCategories = generic_categories.reject{|e| get_initial_categories(item).include? e.id} %> 
            <%simple_gen = rcCategories.sort{|a,b| b.property_objects.length <=> a.property_objects.length}.first(7)%>
            <% simple_gen.each do |init| %> 
              <ul id="suggestedCategories" class="tagit">
                <li class="tagit-choice" value="<%= init.id %>" ><%=init.title%></li>
              </ul>
            <% end %>
         </div>

        <p class="information"><%= t("category.categorized_like")%></p>
        <%tagArray= generic_categories.map{|e| e.title}%>
        <script type="text/javascript">
        $(document).ready(function() {
            var tagList= [
              <%tagArray.each do |tags|%>
                "<%=tags%>",
              <%end%>
            ];
            $("#myCategories").tagit({
              watermarkAllowMessage: "<%= t('category.tagit_watermark_cat')%>",
              tagSource: tagList
            });
            <% resource_categories = get_initial_categories(item) %>
              <% resource_categories.each do |cat| %>
                <% ident = Category.find(cat) %>
                $("#myCategories").tagit("add", "<%=ident.title %>", "<%=ident.id%>");
            <%end%> 
            //Save suggested categories state


     <!--<p class= "information"><%= t("category.cat_popular")%></p>-->
     <br>
     <div id="suggested_categories" class="tagBoxNew">
        <% rcCategories = generic_categories.reject{|e| get_initial_categories(item).include? e.id} %> 
        <%simple_gen = rcCategories.sort{|a,b| b.property_objects.length <=> a.property_objects.length}.first(7)%>
        <ul id="suggestedCategories" class="tagit">
        <% simple_gen.each do |init| %> 
          
            <li class="tagit-choice" value="<%= init.id %>" ><%=init.title%></li>
          
        <% end %>
        </ul>
     </div>
    <p class="information"><%= t("category.categorized_like")%></p>
    <%tagArray= generic_categories.map{|e| e.title}%>
    <script type="text/javascript">
    $(document).ready(function() {
        var tagList= [
          <%tagArray.each do |tags|%>
            "<%=tags%>",
          <%end%>
        ];
        $("#myCategories").tagit({
          watermarkAllowMessage: "<%= t('category.tagit_watermark_cat')%>",
          tagSource: tagList
        });
        </script>
        <div class="tagBoxNew">
          <ul id="myCategories">
        <!-- Existing list items will be pre-added to the tags -->
            
          </ul>
        </div>

      </div>
      <div class="modal-footer">
        <button id="cancel_cat_button" data-dismiss="modal" aria-hidden="true"><%=t('cancel')%></button>
        <button id="save_cat_button"><%= t('button.save')%></button>
      </div>
    </div>
  </div> 
</div>
<script>

  //When click to suggested they go to down part for being categorized
  $("#suggested_categories li").click(function(){
    var value = $(this).html();
    var name = $(this).html();

    $("#myCategories").tagit("add", name, value);
  });

  //TODO: Make it work
  $("#catDropdownSel li").click(function(){
    var value = $(this).children().html();
    var name = $(this).children().html();

    $("#myCategories").tagit("add", name, value);
  });

  //When saving gathering all tags and sending to server
  $("#save_cat_button").click(function() {
    var cat_done_array = [];

    $("#myCategories .tagit-choice").each(function(index,elem){

        cat_done_array.push({title: $(elem).text()});
      }
    });

    $.ajax({
            url: '/categories/categorize',
            type: 'POST',
            dataType: "json",
            data: { activity_object_id:"<%=item.activity_object.id
  .to_s%>", category_array: JSON.stringify(cat_done_array) },
              success: function(data){
                $("#categories_viewer_modal").modal('toggle');

                //Emulating alert with javascript
                $('#flash').hide(); 
                $("#flash").append('<div class="alert alert-success"><button type="button" class="close" data-dismiss="alert">×</button><%=t("category.success")%></div>')
                            .fadeIn()
                            .delay(6000)
                            .fadeOut(300, function(){
                              $('#flash').html("");
                            });

                },
                error: function(){
                  $("#categories_viewer_modal").modal('toggle');
                  //Emulating alert with javascript
                  $('#flash').hide(); 
                  $("#flash").append('<div class="alert alert-success"><button type="button" class="close" data-dismiss="alert">×</button>Error</div>')
                            .fadeIn()
                            .delay(6000)
                            .fadeOut(300, function(){
                              $('#flash').html("");
                            });
                }

    });
  });

  $("#cancel_cat_button").click(function() {
    $("#myCategories").tagit("reset");
    for (key in appliedTags){
      $("#myCategories").tagit("add",appliedTags[key]);
    }
    $("#categories_viewer_modal").modal('toggle');
  });

    var appliedTags = [];
    $('#categories_viewer_modal').on('shown', function() {
      $("#myCategories .tagit-choice").each(function(index,elem){
        appliedTags.push($(elem).text());
       });
      });

</script>